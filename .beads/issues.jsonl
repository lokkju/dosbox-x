{"id":"DBX-09l","title":"QMP: Add save/load state commands","description":"Add QMP commands to save and load emulator state. Essential for automated testing checkpoints.\n\nProposed commands:\n```json\n{\"execute\": \"save-state\", \"arguments\": {\"filename\": \"/tmp/state.sav\"}}\n{\"execute\": \"load-state\", \"arguments\": {\"filename\": \"/tmp/state.sav\"}}\n```","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-18T19:20:59.87015942-08:00","updated_at":"2025-12-19T19:34:25.815513126-08:00","closed_at":"2025-12-19T19:34:25.815513126-08:00","close_reason":"Implemented savestate/loadstate QMP commands with host file support","labels":["feature","qmp"]}
{"id":"DBX-0q3","title":"QMP: Add screenshot to host file command","description":"Add a QMP command to capture the current screen to a file on the host. Useful for automated testing and verification.\n\nProposed command format:\n```json\n{\"execute\": \"screendump\", \"arguments\": {\"filename\": \"/tmp/screen.png\", \"format\": \"png\"}}\n```\n\nThis mirrors QEMU's screendump command.","design":"## Existing Functionality\n\nIn `src/hardware/hardware.cpp`:\n- `CAPTURE_ScreenShotEvent(true)` - sets capture flag, async capture on next frame\n- `CAPTURE_AddImage()` - called during render, writes PNG to capture directory\n- Global `pathscr` stores the last screenshot path\n- PNG format only, auto-numbered filenames\n\n## Challenge\n\nScreenshot is asynchronous - happens during next frame render. Need to:\n1. Trigger capture\n2. Wait for completion (poll or callback)\n3. Read file or return path\n\n## Implementation Plan\n\n1. Add `CAPTURE_ScreenShotToFile(const char* filepath)` that:\n   - Sets a specific output path instead of auto-generated\n   - Sets capture flag\n   - Returns immediately (async)\n2. Add `CAPTURE_IsCapturing()` to check if capture is pending\n3. Add QMP command `screendump` with arguments:\n   - `file`: output path (optional - if omitted, use temp file and return base64)\n4. QMP handler polls until capture completes, then returns\n\n## QMP Protocol\n\n```json\n{\"execute\": \"screendump\", \"arguments\": {\"file\": \"/tmp/screen.png\"}}\n{\"execute\": \"screendump\"}\n```\n\n## Alternative Simpler Approach\n\nJust trigger normal screenshot and return the auto-generated path from `pathscr`.","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-18T19:20:47.817127484-08:00","updated_at":"2025-12-19T18:18:09.694875945-08:00","closed_at":"2025-12-19T18:18:09.694875945-08:00","close_reason":"Implemented screendump QMP command with base64 return and file copy options","labels":["feature","qmp"]}
{"id":"DBX-18m","title":"Add integration tests for GDB/QMP servers","description":"Create external integration tests (Python scripts) that connect to the GDB and QMP servers and verify basic functionality. Avoids need for refactoring code for unit testability.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T00:29:09.2390112-08:00","updated_at":"2025-12-18T18:26:31.435886648-08:00","closed_at":"2025-12-18T18:26:31.435886648-08:00","close_reason":"Complete - Integration tests added for GDB server, QMP server, and video tools. 67 tests passing."}
{"id":"DBX-1p7","title":"QMP: Add mouse input commands","description":"Add QMP commands for mouse input injection. Useful for automating GUI interactions in DOS/Windows applications.\n\nProposed commands:\n```json\n{\"execute\": \"mouse-move\", \"arguments\": {\"x\": 100, \"y\": 200, \"absolute\": true}}\n{\"execute\": \"mouse-button\", \"arguments\": {\"button\": \"left\", \"down\": true}}\n```\n\nCould also support QEMU's input-send-event format for mouse events.","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-18T19:20:54.277261271-08:00","updated_at":"2025-12-20T13:02:04.440988072-08:00","closed_at":"2025-12-20T13:02:04.440988072-08:00","close_reason":"Implemented mouse input via input-send-event (rel for movement, btn for buttons). All tests passed.","labels":["feature","qmp"]}
{"id":"DBX-2jd","title":"Clean up old threading code and temporary debug logging","description":"Remove temporary debug code and any leftover threading artifacts.\n\n## Changes\n- Remove debug printf/LOG statements added during debugging\n- Remove any unused threading-related includes\n- Clean up any dead code paths\n- Verify no memory leaks from socket handling","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-27T11:43:33.561208521-08:00","updated_at":"2025-12-27T13:27:27.117243598-08:00","closed_at":"2025-12-27T13:27:27.117243598-08:00","close_reason":"Completed - removed unused thread include and verbose debug logging","dependencies":[{"issue_id":"DBX-2jd","depends_on_id":"DBX-a3o","type":"blocks","created_at":"2025-12-27T11:43:33.561863074-08:00","created_by":"daemon"},{"issue_id":"DBX-2jd","depends_on_id":"DBX-gon","type":"blocks","created_at":"2025-12-27T11:44:29.32575236-08:00","created_by":"daemon"}]}
{"id":"DBX-2uq","title":"Add QMP debug-break-on-exec command","description":"Add a simple QMP command to set the break-on-exec flag that the internal debugger already supports.\n\n## Command\n```json\n{\"execute\": \"debug-break-on-exec\", \"arguments\": {\"enabled\": true}}\n```\n\n## Implementation\n- Set `debugger_break_on_exec = enabled`\n- Returns success/failure\n- When DOS loads a program and this flag is set, breakpoint is automatically set at entry point","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-27T11:43:33.088428767-08:00","updated_at":"2025-12-27T13:21:16.568323381-08:00","closed_at":"2025-12-27T13:21:16.568323381-08:00","close_reason":"Completed - debug-break-on-exec QMP command added and tested","dependencies":[{"issue_id":"DBX-2uq","depends_on_id":"DBX-a3o","type":"blocks","created_at":"2025-12-27T11:43:33.089089091-08:00","created_by":"daemon"},{"issue_id":"DBX-2uq","depends_on_id":"DBX-r52","type":"blocks","created_at":"2025-12-27T11:44:28.803325101-08:00","created_by":"daemon"}]}
{"id":"DBX-3da","title":"Rename C_GDBSERVER to C_REMOTEDEBUG","description":"Rename the build flag from C_GDBSERVER to C_REMOTEDEBUG to better reflect that it covers both GDB remote debugging and QMP keyboard input protocols.","status":"closed","priority":1,"issue_type":"chore","created_at":"2025-12-16T22:32:20.413564306-08:00","updated_at":"2025-12-16T22:41:32.354244916-08:00","closed_at":"2025-12-16T22:41:32.354244916-08:00","close_reason":"Renamed C_GDBSERVER to C_REMOTEDEBUG across all files","dependencies":[{"issue_id":"DBX-3da","depends_on_id":"DBX-mbt","type":"blocks","created_at":"2025-12-16T22:32:20.414630321-08:00","created_by":"daemon"}]}
{"id":"DBX-3dt","title":"GDB 'c' (continue) command does not resume execution","description":"Report: After connecting GDB, enabling debug-break-on-exec via QMP, typing a command to run an EXE, and hitting the breakpoint - the GDB 'c' command does not resume execution. The emulator stays paused and keyboard input stops working.\n\nSymptoms observed:\n- Screen shows partial command (e.g., \"Z:\\BI\") with flashing cursor\n- Cannot type anything\n- QMP query-status may show running=True but emulator is frozen\n- QMP 'cont' command or reconnecting GDB and sending 'c' again may recover\n\nNeed to reliably reproduce this to identify root cause. Use screen capture via GDB memory reads to verify when keys are sent but not appearing.","acceptance_criteria":"- Can reliably reproduce the bug with a test script\n- Root cause identified\n- Fix implemented and tested\n- All integration tests pass","notes":"## Investigation Notes\n\n### Observations:\n1. break-on-exec DOES trigger - S05 is sent when program loads\n2. Sometimes get duplicate S05 messages (`$S05#b8$S05#b8`)\n3. After breakpoint, QMP shows `debug.paused: True` correctly\n4. When GDB client disconnects, emulator auto-resumes (gdb_cpu_paused = false)\n\n### Potential issues:\n1. Duplicate S05 - may indicate breakpoint triggering twice\n2. Halt/continue cycling during key entry may cause race conditions\n3. When 'c' is sent, ACK (+) is received but execution may not resume\n\n### To reproduce:\n1. Start DOSBox-X with gdbserver and qmpserver enabled\n2. Connect GDB client\n3. Enable break-on-exec via QMP\n4. Type command via QMP (e.g., MEM + Enter)\n5. Wait for breakpoint (S05)\n6. Send 'c' command\n7. Check if execution resumes (send more keys, check screen)\n\n### Files involved:\n- src/debug/debug.cpp: DEBUG_CheckGDBStep(), GDBAction::CONTINUE handling\n- src/debug/gdbserver.cpp: process_command(), poll()\n- src/dosbox.cpp: main loop calling DEBUG_CheckGDBStep()","status":"closed","priority":1,"issue_type":"bug","assignee":"claude","created_at":"2025-12-27T23:07:39.255015687-08:00","updated_at":"2025-12-28T02:09:16.592669937-08:00","closed_at":"2025-12-28T02:09:16.592669937-08:00","close_reason":"Fixed: GDBClient.continue_() was waiting for a response packet after sending 'c', but GDB protocol only sends ACK (+) immediately - the response (S05) comes later when execution stops. Fixed by changing continue_() to just read the ACK without waiting for a full response packet. Also added wait_for_stop() method for when you need to wait for execution to stop.","labels":["bug","gdb","remotedebug"]}
{"id":"DBX-6ep","title":"Update REMOTEDEBUG documentation","description":"Update the remote debugging documentation to reflect the new architecture.\n\n## Topics to cover\n- Break-on-exec options:\n  - Using DEBUGBOX (external orchestration tool)\n  - Using the new `debug-break-on-exec` QMP command\n- QMP commands for typing executable names (send-key, input-send-event)\n- GDB server integration with internal debugger\n- Removed `debug-execute` command (deprecated)\n\n## Files to update\n- Look for existing REMOTEDEBUG documentation\n- May need to create new documentation if none exists","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-27T12:46:34.161685966-08:00","updated_at":"2025-12-27T14:16:55.130853661-08:00","closed_at":"2025-12-27T14:16:55.130853661-08:00","close_reason":"Documentation updated with mouse input, debug-break-on-exec, and debugging program entry points sections.","labels":["documentation","remotedebug"],"dependencies":[{"issue_id":"DBX-6ep","depends_on_id":"DBX-a3o","type":"blocks","created_at":"2025-12-27T13:24:32.503131089-08:00","created_by":"daemon"}]}
{"id":"DBX-70r","title":"Review branch changes against master for extraneous modifications","description":"Compare the refactor/gdb-debugger-integration branch against master to ensure we haven't introduced any unnecessary or extraneous changes.\n\n## Checklist\n- Review git diff master...HEAD for unintended changes\n- Verify no debug code left in (printf, unnecessary LOG statements)\n- Check for any accidental whitespace-only changes\n- Ensure no unrelated files were modified\n- Confirm all changes are intentional and documented","notes":"## Review Completed\n\n### Debug code check\n- All LOG statements use appropriate LOG_REMOTE log type with proper levels:\n  - LOG_NORMAL: Server start/stop, client connect/disconnect\n  - LOG_WARN: Rejecting connections, unknown key codes\n  - LOG_ERROR: Socket failures\n  - LOG_DEBUG: Packet contents, step/continue commands\n- One printf in DEBUG_Enable (\"Breakpoint hit! Entering debugger.\") is intentional user notification\n\n### Files modified (intentional)\n- src/debug/debug.cpp: GDB integration, mutual exclusion\n- src/debug/gdbserver.cpp: Non-blocking GDB server (new)\n- src/debug/qmp.cpp: QMP server with debug-break-on-exec (new)\n- src/debug/debug_gui.cpp: LOG_REMOTE type setup\n- src/debug/Makefile.am: Add new source files\n- include/debug.h, gdbserver.h, qmp.h: Headers\n\n### Integration changes (intentional)\n- configure.ac: --enable-remotedebug flag\n- dosbox.cpp: Server initialization\n- menu_callback.cpp, menu.h: Menu toggles\n- logging.h: LOG_REMOTE enum\n\n### Tests updated\n- Removed TestDebugExecute class (command removed)\n- Updated docstring references\n- All 4 GDB pause state tests pass\n\nNo extraneous or unintended changes found.","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-27T13:24:32.415355093-08:00","updated_at":"2025-12-27T14:15:24.066884451-08:00","closed_at":"2025-12-27T14:15:24.066884451-08:00","close_reason":"Review complete. All changes are intentional, no debug code or extraneous modifications found.","dependencies":[{"issue_id":"DBX-70r","depends_on_id":"DBX-a3o","type":"blocks","created_at":"2025-12-27T13:24:32.41626869-08:00","created_by":"daemon"}]}
{"id":"DBX-82p","title":"QMP: Add memory dump to host file command","description":"Add a QMP command to dump a range of emulated memory to a file on the host system. Useful for debugging and automated testing.\n\nProposed command format:\n```json\n{\"execute\": \"dump-memory\", \"arguments\": {\"start\": 0xB8000, \"length\": 4000, \"filename\": \"/tmp/videomem.bin\"}}\n```","design":"## Existing Functionality\n\nIn `src/debug/debug.cpp`:\n- `SaveMemoryBin(uint16_t seg, uint32_t ofs1, uint32_t num)` - static function, writes raw binary to MEMDUMP.BIN\n- `SaveMemory(uint16_t seg, uint32_t ofs1, uint32_t num)` - static function, writes hex dump to MEMDUMP.TXT\n- `DEBUG_ReadMemory(uint32_t address)` - public, reads one byte (too slow for large dumps)\n\n## Implementation Plan\n\n1. Create public wrapper `DEBUG_SaveMemoryBin(const char* filepath, uint32_t address, uint32_t size)` in debug.cpp\n2. Add QMP command `memdump` with arguments:\n   - `address`: linear address (required)\n   - `size`: bytes to dump (required)\n   - `file`: output path (optional - if omitted, use temp file and return base64)\n3. Return format:\n   - With file: `{\"file\": \"/path/to/file\", \"size\": N}`\n   - Without file: `{\"data\": \"\u003cbase64\u003e\", \"size\": N}`\n\n## QMP Protocol\n\n```json\n{\"execute\": \"memdump\", \"arguments\": {\"address\": 0, \"size\": 65536, \"file\": \"/tmp/dump.bin\"}}\n{\"execute\": \"memdump\", \"arguments\": {\"address\": 0, \"size\": 1024}}\n```","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-18T19:20:41.328728638-08:00","updated_at":"2025-12-19T09:42:01.878534096-08:00","closed_at":"2025-12-19T09:42:01.878534096-08:00","close_reason":"Implemented memdump QMP command with base64 return and file save options","labels":["feature","qmp"]}
{"id":"DBX-83n","title":"QMP: Add emulator control commands (pause/resume/reset)","description":"Add QMP commands for basic emulator control.\n\nProposed commands:\n```json\n{\"execute\": \"stop\"}        // Pause emulation\n{\"execute\": \"cont\"}        // Resume emulation  \n{\"execute\": \"system_reset\"} // Reset the emulated system\n{\"execute\": \"quit\"}        // Exit DOSBox-X (already partially supported)\n```\n\nThese mirror QEMU's control commands.","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-18T19:21:06.27390548-08:00","updated_at":"2025-12-20T12:48:30.350515207-08:00","closed_at":"2025-12-20T12:48:30.350515207-08:00","close_reason":"Implemented stop, cont, system_reset, and query-status QMP commands. All tests passed.","labels":["feature","qmp"]}
{"id":"DBX-a3o","title":"Refactor GDB server to integrate with internal debugger","description":"Refactor the GDB server from a threaded architecture to a non-blocking integration with the internal debugger. The GDB server should become an alternative UI to the ncurses debugger TUI, calling the same internal debugger functions (step, continue, read registers, etc.) rather than trying to control execution through flags and signals.\n\n## Goals\n- Eliminate threading complexity and socket race conditions\n- GDB becomes alternative debugger UI (mutual exclusion with ncurses TUI)\n- Simpler, more maintainable code\n- Proper breakpoint notification (S05) without cross-thread issues\n\n## Architecture\n- GDB socket becomes non-blocking, polled in debug loop\n- When GDB client connected, ncurses input ignored\n- GDB commands call same functions as TUI commands\n- Breakpoint hit → send S05 directly (single-threaded, no races)","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-27T11:43:00.16261322-08:00","updated_at":"2025-12-27T14:17:09.35267043-08:00","closed_at":"2025-12-27T14:17:09.35267043-08:00","close_reason":"All subtasks completed: Non-blocking GDB server, debugger integration, debug-break-on-exec, cleanup, tests, review, and documentation."}
{"id":"DBX-ard","title":"QMP: Add base64 data transfer for savestate/loadstate","description":"Add optional base64 data transfer support to savestate/loadstate commands for remote state management.\n\nCurrently savestate/loadstate only support host file paths. For remote automation scenarios (CI/CD pipelines, remote debugging), it would be useful to transfer state data directly via base64 encoding, similar to how memdump and screendump work.\n\nProposed enhancement:\n- If no `file` argument given to savestate, return state as base64 in response\n- If `data` argument given to loadstate instead of `file`, accept base64 state data\n\nNote: State files can be large (100KB+), so this is lower priority than file-based operations.","status":"open","priority":4,"issue_type":"feature","created_at":"2025-12-19T19:34:19.888945815-08:00","updated_at":"2025-12-19T19:34:19.888945815-08:00","labels":["enhancement","feature","qmp"]}
{"id":"DBX-azs","title":"GDB server handshake fails with dbxdebug client","description":"When connecting with dbxdebug 0.2.1 Python client, the GDB server logs:\n```\nGDBServer: Client connected\nGDBServer: Unexpected initial packet - \nGDBServer: Handshake failed\n```\n\nThe client sends a valid qSupported packet with correct checksum, but the server receives an empty string. This suggests either:\n1. Checksum mismatch causing receive_packet() to return \"\"\n2. Some bytes being lost/corrupted in transmission\n3. Encoding issue between Python bytes and C++ char","design":"Investigation needed:\n1. Add LOG_DEBUG output in receive_packet() to show raw bytes received\n2. Log the calculated vs received checksum values\n3. Test with raw telnet/netcat to isolate client vs server issue\n4. Compare with GDB proper to see if it works","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-18T16:49:20.439712671-08:00","updated_at":"2025-12-18T18:12:41.398395404-08:00","closed_at":"2025-12-18T18:12:41.398395404-08:00","close_reason":"Fixed - was caused by noack_mode persisting between client connections; now reset on disconnect","labels":["gdbserver","handshake"]}
{"id":"DBX-ck9","title":"Refactor gdbserver.cpp to non-blocking architecture","description":"Remove threading from GDB server and convert to non-blocking socket operations.\n\n## Changes\n- Remove `std::thread`, mutexes, condition variables, atomic flags\n- Make server socket and client socket non-blocking\n- Add `poll()` or `check_and_handle()` function for main loop to call\n- `accept()` becomes non-blocking (returns immediately if no client)\n- Keep packet parsing/building logic, just non-blocking\n- Remove `paused_for_gdb`, `pending_command`, `waiting_for_completion` atomics\n\n## New interface\n```cpp\nclass GDBServer {\n    void start();           // Setup socket, non-blocking\n    void stop();            // Close sockets\n    bool poll();            // Check for new clients, handle pending data\n    bool has_client();      // Is a client connected?\n    void send_stop(int signal);  // Send stop reply (S05, etc.)\n    // ... other query methods\n};\n```","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T11:43:32.518067116-08:00","updated_at":"2025-12-27T12:27:46.658618481-08:00","closed_at":"2025-12-27T12:27:46.658618481-08:00","close_reason":"Completed - GDBServer refactored to non-blocking architecture with poll() interface","dependencies":[{"issue_id":"DBX-ck9","depends_on_id":"DBX-a3o","type":"blocks","created_at":"2025-12-27T11:43:32.519824938-08:00","created_by":"daemon"}]}
{"id":"DBX-ef9","title":"Fix dbxdebug QMPClient.type_text to handle special characters","description":"The dbxdebug library's QMPClient.type_text() method cannot handle special characters like ':'. This requires workarounds in tests using send_key with shift+semicolon instead of typing ':' directly.\n\nError seen: \"WARNING | dbxdebug.qmp:type_text:205 - Cannot type character: ':'\"\n\nWorkaround used in tests:\n```python\n# Instead of: qmp.type_text(f\"{drive}:\")\n# Use:\nqmp.send_key([drive.lower()])  # Letter\nqmp.send_key([\"shift\", \"semicolon\"])  # Colon\n```\n\nThis should be fixed in the dbxdebug library to support common special characters.","status":"closed","priority":3,"issue_type":"bug","created_at":"2025-12-26T23:33:02.926391815-08:00","updated_at":"2025-12-27T14:28:24.574076556-08:00","closed_at":"2025-12-27T14:28:24.574076556-08:00","close_reason":"Moved to lokkju/dbxdebug#1 - this is a dbxdebug library issue, not DOSBox-X","labels":["dbxdebug","qmp","testing"]}
{"id":"DBX-ejk","title":"Update REMOTEDEBUG.md documentation","description":"Update the REMOTEDEBUG.md documentation to reflect recent changes:\n\n1. Document DOSBoxInstance Python class for test automation\n2. Add examples using the new `run_command()` helper\n3. Document `wait_for_stop()` method for GDB client\n4. Add troubleshooting section for key dropping issues (workaround: use delay=0.15+)\n5. Document the `debug-break-on-exec` QMP command with examples\n6. Add section on entry point addresses (COM at 0x100, EXE at 0x0000)\n7. Update any outdated examples or API references","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-28T02:19:20.439752207-08:00","updated_at":"2025-12-28T02:19:20.439752207-08:00","labels":["documentation","remotedebug"]}
{"id":"DBX-gon","title":"Update integration tests for new GDB architecture","description":"Update the integration tests to work with the new GDB server architecture.\n\n## Changes\n- Remove tests for debug-execute command\n- Update GDB connection tests (no threading-related edge cases)\n- Test mutual exclusion (GDB connected blocks TUI)\n- Test breakpoint → S05 notification flow\n- Test basic GDB operations (step, continue, registers, memory)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T11:43:33.334227439-08:00","updated_at":"2025-12-27T14:13:02.667710444-08:00","closed_at":"2025-12-27T14:13:02.667710444-08:00","close_reason":"Removed TestDebugExecute class, updated docstring. All 4 GDB pause state tests pass.","dependencies":[{"issue_id":"DBX-gon","depends_on_id":"DBX-a3o","type":"blocks","created_at":"2025-12-27T11:43:33.334886561-08:00","created_by":"daemon"},{"issue_id":"DBX-gon","depends_on_id":"DBX-jqn","type":"blocks","created_at":"2025-12-27T11:44:29.059472804-08:00","created_by":"daemon"}]}
{"id":"DBX-hfb","title":"QMP send-key drops keystrokes at high rates","description":"When sending multiple keystrokes via QMP send-key in quick succession, some keystrokes are dropped AND the emulator can become completely frozen to all input. This causes test reliability issues and requires workarounds.\n\nSymptoms:\n- Typing \"DEBUGBOX DBXTEST.COM\" may result in \"DEB\" or partial text\n- The emulator becomes COMPLETELY FROZEN - no keyboard input works at all\n- Not just \"appears frozen\" - a total input lockup occurs\n- Suggests a race condition causing a lock\n\nRoot causes to investigate:\n- Race condition in keyboard/input handling causing lock\n- Keyboard buffer overflow in DOSBox-X\n- Timing between send-key press and release events  \n- SDL event queue saturation\n- Possible mutex/lock contention in input path\n\nCurrent workarounds:\n1. Increasing inter-key delay to 0.15s+ (very slow for long strings)\n2. Verifying screen output after typing (adds halt/continue overhead)\n\nPotential solutions:\n1. Add a native QMP `send-text` command that handles reliable text entry\n2. Implement keyboard buffer management in send-key\n3. Add automatic pacing in the QMP server\n4. Fix the race condition causing the lock","notes":"## Root Cause Analysis\n\n### Finding 1: Thread Safety Issue\nThe QMP server calls `KEYBOARD_AddKey()` directly from its server thread, but the keyboard buffer is accessed by the main SDL event loop thread. **There is no mutex protection.**\n\nLocation: `src/hardware/keyboard.cpp` - `KEYBOARD_AddBuffer()` at line 340\n\n### Finding 2: Destructive Buffer Overflow Handling\nWhen `KEYBOARD_AddBuffer()` is called with a full buffer (96 entries):\n```cpp\nif (keyb.used\u003e=KEYBUFSIZE) {\n    LOG(LOG_KEYBOARD,LOG_NORMAL)(\"Buffer full, dropping code\");\n    KEYBOARD_ClrBuffer(); return;  // CLEARS ENTIRE BUFFER!\n}\n```\n\nThis is catastrophic - when buffer fills:\n1. ALL pending keystrokes are wiped (not just the overflow)\n2. The new keystroke is also dropped\n3. Key release events may be lost, leaving keys \"stuck\"\n\n### Finding 3: Hold Time Blocking\nQMP `send-key` sleeps for 100ms per key (default hold-time). If multiple commands queue up, they all try to add keys at once, causing buffer overflow.\n\nLocation: `src/debug/qmp.cpp` line 497:\n```cpp\nstd::this_thread::sleep_for(std::chrono::milliseconds(hold_time));\n```\n\n### Finding 4: Race Condition Scenario\n1. QMP thread adds key 'D' press\n2. QMP thread sleeps 100ms\n3. Main thread processes some keys\n4. QMP receives next command while still sleeping\n5. After wake, QMP adds key release + next key press\n6. If buffer overflows → `KEYBOARD_ClrBuffer()` wipes everything\n7. Key release for previous key is lost → KEY IS NOW STUCK\n8. Emulator \"freezes\" because modifier keys or other keys are stuck pressed\n\n### Proposed Fix\nUse `SDL_PushEvent()` instead of `KEYBOARD_AddKey()` directly. This is thread-safe (SDL handles locking internally). Example from `clipboard.cpp`:\n```cpp\nSDL_Event evntKeyStroke = { 0 };\nevntKeyStroke.type = bDepressed ? SDL_KEYDOWN : SDL_KEYUP;\nevntKeyStroke.key.keysym.sym = sdlkey;\nevntKeyStroke.key.state = bDepressed ? SDL_PRESSED : SDL_RELEASED;\nSDL_PushEvent(\u0026evntKeyStroke);\n```","status":"closed","priority":2,"issue_type":"feature","assignee":"claude","created_at":"2025-12-28T02:13:33.213103022-08:00","updated_at":"2025-12-28T02:33:31.526884971-08:00","closed_at":"2025-12-28T02:33:31.526884971-08:00","close_reason":"Fixed by implementing thread-safe input event queue.\\n\\nChanges:\\n- Added QMPInputEvent struct and QMPInputEventType enum in qmp.h\\n- Added mutex-protected queue to QMPServer class\\n- Modified handle_send_key() to queue key press/release events instead of calling KEYBOARD_AddKey() directly (no more 100ms blocking sleep per key)\\n- Modified handle_input_send_event() to queue keyboard and mouse events\\n- Added QMP_ProcessPendingInputEvents() called from main loop in dosbox.cpp\\n\\nThe fix ensures:\\n1. Thread safety - QMP server thread queues events, main thread processes them\\n2. No more race conditions between QMP and emulator threads\\n3. No blocking sleeps that could cause command queue buildup\\n4. Buffer overflow can't wipe all pending keys since events are processed incrementally\\n5. No more stuck keys from lost release events","labels":["qmp","reliability","remotedebug"]}
{"id":"DBX-jqn","title":"Integrate GDB server into debug.cpp debug loop","description":"Modify the internal debugger to poll GDB server and handle GDB commands as an alternative to ncurses input.\n\n## Changes\n- In debug loop, poll GDB socket alongside ncurses\n- When GDB client connected, ignore ncurses input (mutual exclusion)\n- Map GDB commands to existing debugger functions:\n  - `s` (step) → same as TUI step\n  - `c` (continue) → same as TUI continue/go\n  - `g` (read registers) → read from CPU state\n  - `G` (write registers) → write to CPU state  \n  - `m` (read memory) → use existing memory read functions\n  - `M` (write memory) → use existing memory write functions\n  - `Z`/`z` (breakpoints) → use CBreakpoint class\n- When breakpoint hit and GDB connected, send S05 directly","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T11:43:32.641480801-08:00","updated_at":"2025-12-27T12:37:14.859899551-08:00","closed_at":"2025-12-27T12:37:14.859899551-08:00","close_reason":"Completed - GDB server integrated into debug loop with proper pause/step/continue handling","dependencies":[{"issue_id":"DBX-jqn","depends_on_id":"DBX-a3o","type":"blocks","created_at":"2025-12-27T11:43:32.642715308-08:00","created_by":"daemon"},{"issue_id":"DBX-jqn","depends_on_id":"DBX-ck9","type":"blocks","created_at":"2025-12-27T11:44:28.451693037-08:00","created_by":"daemon"}]}
{"id":"DBX-k6u","title":"GDB server crashes on toggle due to use-after-free","description":"DEBUG_StopGDBServer() deletes gdbServer immediately after calling stop(), but the detached server thread is still running and will access freed memory when its blocking accept()/read() call returns.\n\nThe crash occurs when toggling Debug \u003e GDB Server menu item while a client was connected or the server is blocked.","design":"Fix options:\n1. Use a joinable thread instead of detached, call join() after stop()\n2. Add a condition variable for clean shutdown signaling\n3. Use shared_ptr or ensure thread exits before delete\n\nRecommended: Option 1 - change to joinable thread:\n- Store std::thread in GDBServer class\n- Add join() method that waits for thread to exit\n- In stop(), set running=false, close sockets (unblocks thread), then join\n- Call join() from DEBUG_StopGDBServer() before delete","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-18T16:49:20.31226014-08:00","updated_at":"2025-12-18T18:12:41.183242695-08:00","closed_at":"2025-12-18T18:12:41.183242695-08:00","close_reason":"Fixed - server thread is now joinable and stop() waits for it to exit before deleting the object","labels":["crash","gdbserver","threading"]}
{"id":"DBX-kl2","title":"Refactor dosbox_debug.py to share GDB connection between clients","description":"Currently DOSVideoTools creates its own GDB connection, which conflicts when GDBClient is already connected. This causes timeouts and connection issues.\n\nRefactor to:\n1. Allow DOSVideoTools to accept an existing GDBClient instance\n2. Or implement a connection manager/pool\n3. Ensure screen capture works while debugging without opening new connections","acceptance_criteria":"- DOSVideoTools can use existing GDBClient connection\n- No timeout errors when using video tools during active debug session\n- All integration tests pass\n- Documentation updated","status":"closed","priority":2,"issue_type":"task","assignee":"claude","created_at":"2025-12-27T23:07:48.029478188-08:00","updated_at":"2025-12-28T11:07:06.957678696-08:00","closed_at":"2025-12-28T11:07:06.957678696-08:00","close_reason":"Refactored by moving video methods into GDBClient class.\\n\\nChanges:\\n- Added screen_dump(), screen_line(), screen_raw(), screen_debug(), read_video_mode(), read_timer_ticks() methods to GDBClient\\n- Updated DOSBoxInstance to use gdb.screen_dump() directly instead of separate video property\\n- Removed DOSVideoTools class entirely\\n\\nThis eliminates the connection conflict issue since all video operations now use the existing GDB connection.","labels":["refactor","remotedebug","tests"]}
{"id":"DBX-mbt","title":"Implement QMP-compatible keyboard input protocol","description":"Add a QEMU QMP-compatible protocol for keyboard input injection, separate from the GDB stub. This allows use of existing QEMU tooling and provides a cleaner separation of concerns.\n\nKey components:\n- JSON-based protocol on separate socket\n- send-key command with hold-time support\n- input-send-event for explicit press/release control\n- QKeyCode-compatible key names mapped to DOSBox KBD_KEYS","design":"## Protocol Design\n\nUse QEMU's QMP subset:\n- `send-key`: Array of keys pressed simultaneously, auto-release after hold-time\n- `input-send-event`: Explicit key down/up events\n\n## Key Name Mapping\n\nMap QEMU QKeyCode names to DOSBox KBD_KEYS enum values via static lookup table.\n\n## Implementation Plan\n\n1. Create `include/qmp.h` - QMPServer class declaration\n2. Create `src/debug/qmp.cpp` - QMP server implementation\n   - Socket handling (reuse pattern from gdbserver)\n   - JSON parsing (minimal, just what we need)\n   - Key mapping table\n   - send-key command\n   - input-send-event command\n3. Update `src/debug/Makefile.am` - add qmp.cpp\n4. Update `configure.ac` - gate behind C_QMPSERVER or reuse C_GDBSERVER\n5. Update `src/dosbox.cpp` - add qmp config options\n6. Update `src/debug/debug.cpp` - startup/shutdown\n7. Update docs/GDBSERVER.md or create docs/QMP.md","notes":"Implementation complete. QMP server with send-key and input-send-event commands. Renamed C_GDBSERVER to C_REMOTEDEBUG. Documentation updated.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-16T22:23:09.068905908-08:00","updated_at":"2025-12-16T22:43:39.476902161-08:00","closed_at":"2025-12-16T22:43:39.476902161-08:00","close_reason":"QMP keyboard input protocol implemented and documented"}
{"id":"DBX-o39","title":"Debug server menu checkmarks don't reflect actual state","description":"The Debug menu items for GDB Server and QMP Server should show checkmarks that properly reflect whether each server is currently running.\n\nNeed to verify:\n1. Checkmark appears when server is started\n2. Checkmark disappears when server is stopped\n3. State is correct on initial load based on config settings","status":"closed","priority":3,"issue_type":"bug","created_at":"2025-12-18T18:17:44.137113821-08:00","updated_at":"2025-12-18T18:31:28.267747543-08:00","closed_at":"2025-12-18T18:31:28.267747543-08:00","close_reason":"Fixed - menu checkmarks now update on startup and after toggling","labels":["gdbserver","menu","qmpserver","ui"]}
{"id":"DBX-r52","title":"Remove debug-execute QMP command","description":"Remove the debug-execute command from QMP since DEBUGBOX will handle this orchestration.\n\n## Changes\n- Remove `handle_debug_execute()` from qmp.cpp\n- Remove from command registration\n- Remove `gdb_break_on_exec` flag (or repurpose for QMP break-on-exec command)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T11:43:32.872181432-08:00","updated_at":"2025-12-27T12:47:56.464839182-08:00","closed_at":"2025-12-27T12:47:56.464839182-08:00","close_reason":"Completed - debug-execute QMP command removed","dependencies":[{"issue_id":"DBX-r52","depends_on_id":"DBX-a3o","type":"blocks","created_at":"2025-12-27T11:43:32.872872915-08:00","created_by":"daemon"}]}
{"id":"DBX-u51","title":"Audit QMP for thread safety issues","description":"Audit all QMP command handlers to ensure they don't have similar thread safety issues as found in send-key (DBX-hfb).\n\nCheck for:\n1. Direct calls to emulator functions from QMP thread without synchronization\n2. Access to shared state without mutex protection\n3. Blocking sleeps that could cause command queue buildup\n4. Functions that modify state consumed by main thread (keyboard, mouse, memory, etc.)\n\nQMP functions to audit:\n- handle_send_key (KNOWN ISSUE - DBX-hfb)\n- handle_input_send_event (mouse input)\n- handle_memdump (reads memory)\n- handle_screendump (reads video memory)\n- handle_savestate / handle_loadstate\n- handle_stop / handle_cont\n- handle_system_reset\n- handle_query_status\n- handle_debug_break_on_exec\n\nFor each, verify thread-safety of any emulator functions called.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T02:24:00.299648915-08:00","updated_at":"2025-12-28T02:26:43.780387584-08:00","closed_at":"2025-12-28T02:26:43.780387584-08:00","close_reason":"Closed via update","labels":["audit","qmp","thread-safety"],"dependencies":[{"issue_id":"DBX-u51","depends_on_id":"DBX-hfb","type":"blocks","created_at":"2025-12-28T02:24:00.300928297-08:00","created_by":"daemon"}]}
{"id":"DBX-z6v","title":"GDB step/continue don't execute from separate thread","description":"DEBUG_Step() and DEBUG_Continue() call DEBUG_CheckKeys() to simulate F11/F5 keypresses in the debugger, but when called from the GDB server thread, the main emulator loop doesn't process them.\n\nResult: step command returns S05 response but EIP doesn't change - the instruction isn't actually executed.\n\nThis is a threading/synchronization issue between the GDB server thread and the main emulator thread.","design":"Options:\n1. Use a condition variable or event to signal the main thread to execute step/continue\n2. Have the GDB server set a flag that the main loop checks\n3. Use SDL events to communicate with main thread\n4. Refactor debugger to be thread-safe\n\nThe proper fix likely requires main loop integration rather than just simulating keypresses.","notes":"Implemented direct execution path for step/continue when GDB server is running. Needs testing to verify it works correctly.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-18T18:10:20.693056402-08:00","updated_at":"2025-12-19T08:42:21.957448154-08:00","closed_at":"2025-12-19T08:42:21.957448154-08:00","close_reason":"Fixed: Implemented thread-safe step/continue with proper synchronization between GDB server thread and main emulator loop. All 23 GDB server tests now pass.","labels":["gdbserver","threading"]}
